# font-display によるパフォーマンス改善

## そもそもウェブフォントが反映されるまで流れ

ウェブフォントが反映されるまでには３つの期を通過します。

- フォントブロック期
- フォントスワップ期
- フォント失敗期

なんのこっちゃ。って感じです。

### ３つの期

#### フォントブロック期

最初に訪れる期。フォントがダウンロード完了してない場合は見えないテキスト（プレースホルダーテキスト）を表示し、この時期にダウンロードが完了していればウェブフォントを表示する。

#### フォントスワップ期

フォントがダウンロード完了してない場合は代替フォントを表示します。
この時期にダウンロードが完了していればウェブフォントを表示する。

#### フォント失敗期

フォントがダウンロード完了しない場合、読み込み失敗と判断して代替フォントを表示します。

ちょっとまだわかったような。わからないような。
とりあえずこれらを通して、ウェブフォントはユーザーに表示されるわけです。

## で、font-display ってなに？

ウェブフォントをユーザーに対してどのように表示するかを設定する事ができます。
つまり、上記の期のタイミングでどのようにブラウザに挙動して欲しいかを設定します。

## font-display の値は５つ

### auto

デフォルト値であり、ブラウザ独自の仕様が適用されます。

| Browser    | Timeout    | Fallback | Swap |
| ---------- | ---------- | -------- | ---- |
| Chrome 35+ | 3sec       | Yes      | Yes  |
| Opera      | 3sec       | Yes      | Yes  |
| Firefox    | 3sec       | Yes      | Yes  |
| IE         | 0          | Yes      | Yes  |
| safari     | No timeout | N/A      | N/A  |

https://developers.google.com/web/updates/2016/02/font-display

ちょっと情報が古いみたい。

Chrome88 は３秒またずに代替テキスト表示している swap みたいな挙動をしている

### block

ブロック期 3 秒待つ

スワップ期　永遠に待つ

つまり、

ブラウザにもよりますが最大で３秒見えないテキスト（プレースホルダーテキスト）が表示されます。ウェブフォントがその間にウェブフォントがダウンロードされたら差し替えます。ダウンロードが間に合わない場合は代替フォントを表示します。その後ダウンロードが官僚したらウェブフォントに差し替えます

### swap

ブロック期　 0 秒待つ

スワップ期　永遠に待つ

つまり、

すぐに代替フォントで表示します。ウェブフォントのダウンロードが完了したらウェブフォントに差し替えます

### fallback

ブロック期　 100ms 待つ

スワップ期　３秒待つ

失敗期

つまり

最初に 100ms 以内の見えないテキストを（プレースホルダーテキスト）を表示します。その後すぐにウェブフォントのダウンロードが終わっていればウェブフォントを。ダウンロードが終わってなければ、代替フォントを表示します。代替フォントを表示した場合、3 秒以内にダウンロードが完了すればウェブフォントに差し替えます。間に合わない場合は代替フォントのまま

### optinal

ブロック期 100ms 待つ

スワップ期 0 秒待つ

失敗期

つまり

まず 100ms ほど目に見えないフォントを表示します。その時点でダウンロードが完了してればウェブフォント。終わってなければ代替フォントを表示します。そしてウェブフォントがダウンロード完了しても代替フォントのままです。ただしキャッシュに乗ればリロードやページ遷移でウェブフォントが表示されます。

参考: https://developers.google.com/web/updates/2016/02/font-display

サンプル：https://misc.laboradian.com/font-test/2/

## どの設定がいいのか？

### ネットが高速接続の場合

`swap`がおすすめ。

速度が速いのでウェブフォントもすぐに読み込み完了し、
コンテンツの表示と同時にウェブフォントも適用できる。

### ネットが低速接続の場合

結論からいうと`fallbak`か`optional`がおすすめ。

## 低速な場合なぜ、swap はだめなのか？

低速な環境で`swap`を設定すると何が起こるのか。

`swap`はスワップ期が永遠に続きます。

そのため、ウェブフォントのダウンロードに 10 秒かかった場合。

1. コンテンツが代替フォントで表示される
2. ユーザーがテキストを読み始める
3. 10 秒経ってウェブフォントに差し替える
4. ページ全体でレイアウトシフトが発生する場合がある！？
5. レイアウトシフトが起こってどこ読んでたか見失う可能性も！？

## なぜレイアウトシフトが発生するの？

ウェブフォントによって font-size が同じでも文字のサイズや字間や行間が違うため、
場合によって、１行で収まっていた箇所に改行が発生したりします。

その差分によってレイアウトシフトが起こる可能性があります。

フォントによってどれぐらい差異があるのか下記で確認できたりします。

https://meowni.ca/font-style-matcher/

## 使い方を考えよう

個人的にはまずそのウェブフォントは本当に必要なのか検討したい。

どうしても必要な場合は、適用範囲と利用ユーザーの環境を考慮して設定するとよさそう

なるべく`auto`, `block`の利用はさけて、
`swap`, `fallback`, `optinal` をいい感じに利用したい。

## どうしても swap を使いたい！しかもレイアウトシフトも軽減させたい人へ

Font metrics override を使ってフォント間の差異を軽減させることができるかも！？

| プロパティ        | 説明                                 |
| ----------------- | ------------------------------------ |
| ascent-override   | ベースラインよりも上の高さを設定する |
| descent-override  | ベースラインよりも下の深さを設定する |
| line-gap-override | 行隙間を設定する                     |

https://triple-underscore.github.io/css-fonts4-ja.html#descdef-font-face-ascent-override

もう一つ字間を設定する`advance-override`っていうのがあるらしい。

こちらはまだ議論中？

https://github.com/w3c/csswg-drafts/issues/5983

https://github.com/w3c/csswg-drafts/issues/6075

参考：https://blog.jxck.io/entries/2021-02-25/font-metrics-override.html
