# font-display によるパフォーマンス改善

## font-display とは？

ウェブフォントをユーザーに対してどのように表示するかを設定する事ができます。設定する値によってブラウザの挙動が変わります。

## 値は５つ

| 値       | 説明                                                                                                                                                                                                                                                                                                                                                |
| -------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| auto     | ブラウザの独自の設定が反映されます。block に近い挙動                                                                                                                                                                                                                                                                                                |
| block    | ブラウザにもよりますが最大で３秒見えないテキスト（プレースホルダーテキスト）が表示されます。ウェブフォントがその間にウェブフォントがダウンロードされたら差し替えます。ダウンロードが間に合わない場合は代替フォントを表示します。その後ダウンロードが官僚したらウェブフォントに差し替えます                                                          |
| swap     | すぐに代替フォントで表示します。ウェブフォントのダウンロードが完了したらウェブフォントに差し替えます                                                                                                                                                                                                                                                |
| fallbak  | 最初に 100ms 以内の見えないテキストを（プレースホルダーテキスト）を表示します。その後すぐにウェブフォントのダウンロードが終わっていればウェブフォントを。ダウンロードが終わってなければ、代替フォントを表示します。代替フォントを表示した場合、3 秒以内にダウンロードが完了すればウェブフォントに差し替えます。間に合わない場合は代替フォントのまま |
| optional | まず 100ms ほど目に見えないフォントを表示します。その時点でダウンロードが完了してればウェブフォント。終わってなければ代替フォントを表示します。そしてウェブフォントがダウンロード完了しても代替フォントのままです。ただしキャッシュに乗ればリロードやページ遷移でウェブフォントが表示されます。                                                     |

## どの設定がいいのか？

### ネットが高速接続なら

`swap`がおすすめ。

速度が速いのでウェブフォントもすぐに読み込み完了できるでしょう。

### ネットが高速ではない接続なら

結論からいうと`fallbak`か`optional`がおすすめ。

## swap はなぜだめなのか？

低速な環境で`swap`を設定すると何が起こるのか。
`swap`はウェブフォントのダウンロードが完了するウェブフォントを差し替える設定になっています。
そのため、ウェブフォントのダウンロードに 10 秒かかった場合。

1. コンテンツが代替フォントで表示される
2. ユーザーがテキストを読み始める
3. 10 秒経ってウェブフォントに差し替える
4. ページ全体でレイアウトシフトが発生する！？

## なぜレイアウトシフトが発生するの？

フォントによって１行に収まったり、改行したいりする。
https://meowni.ca/font-style-matcher/

## どうにか swap を使ってレイアウトシフトを軽減したい

Font metrics override を使ってフォント間の差異を軽減する。

| プロパティ        | 説明                       |
| ----------------- | -------------------------- |
| ascent-override   | ベースラインよりも上の高さ |
| descent-override  | ベースラインよりも下の深さ |
| line-gap-override | 行隙間                     |

https://blog.jxck.io/entries/2021-02-25/font-metrics-override.html

https://triple-underscore.github.io/css-fonts4-ja.html#descdef-font-face-ascent-override

advance-override については議論中
https://github.com/w3c/csswg-drafts/issues/5983
https://github.com/w3c/csswg-drafts/issues/6075

## まとめ

block や auto はよほどの理由がないかぎり避けるべき。
そもそもそのウェブフォントは本当に必要なのかを一度考えて、必要ならば、例えばロゴなど影響範囲の少ない場所は`swap`。全体的に利用されているテキストに関しては`fallbak`や`optional`を設定するなど。
